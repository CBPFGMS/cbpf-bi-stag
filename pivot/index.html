<!DOCTYPE html>
<html style="font-family:'Roboto Slab', serif;">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>CBPF Data Pivot Table</title>
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    <link rel="stylesheet" href="../assets/css/Highlight-Phone.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.1.1/aos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css">
    <link rel="stylesheet" href="../assets/css/smoothproducts.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
    <style>
        /* Global text color and font size */
        body {
            color: #000 !important;
            font-size: 12px !important;
        }
        body, body *, 
        .pivot-controls, 
        .pivot-controls *,
        #pivot-table-container,
        #pivot-table-container * {
            color: #000 !important;
        }
        /* Custom styles for loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pivot-controls {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .pivot-controls .form-group {
            margin-bottom: 15px;
        }
        .pivot-controls label {
            font-weight: 600;
            color: #000 !important;
            margin-right: 15px;
            font-size: 11px !important;
        }
        .pivot-controls input[type="text"],
        .pivot-controls input[type="password"],
        .pivot-controls select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            margin-right: 10px;
            font-size: 11px !important;
        }
        .btn-primary {
            background-color: #146eb4;
            border-color: #146eb4;
        }
        .btn-primary:hover {
            background-color: #0e5a9a;
            border-color: #0e5a9a;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        /* Load CSV and Download CSV button text color */
        #load-csv,
        #download-csv {
            color: #b0b0b0 !important;
        }
        #load-csv:hover,
        #download-csv:hover {
            color: #d0d0d0 !important;
        }
        /* Pivot Table Styles */
        #pivot-table-container {
            min-height: 500px;
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: visible !important;
        }
        /* Ensure pivot table UI controls are visible */
        .pvtUi {
            width: 100% !important;
            display: block !important;
            visibility: visible !important;
            min-height: 400px !important;
        }
        /* Pivot table layout */
        .pvtUi table {
            width: 100% !important;
        }
        /* Field list area */
        .pvtAxisContainer {
            background-color: #f8f9fa !important;
            border: 2px solid #146eb4 !important;
            padding: 15px !important;
            margin: 10px 5px !important;
            min-height: 120px !important;
            display: block !important;
            visibility: visible !important;
            border-radius: 4px !important;
        }
        .pvtAxisContainer li {
            background-color: #146eb4 !important;
            color: white !important;
            padding: 8px 12px !important;
            margin: 5px 3px !important;
            border-radius: 4px !important;
            cursor: move !important;
            display: inline-block !important;
            list-style: none !important;
        }
        .pvtAxisContainer li:hover {
            background-color: #0e5a9a !important;
        }
        /* Available fields list */
        .pvtAxisContainer.pvtUnused {
            background-color: #e9ecef !important;
            border-color: #6c757d !important;
        }
        .pvtAxisContainer.pvtUnused li {
            background-color: #6c757d !important;
        }
        .pvtAxisContainer.pvtUnused li:hover {
            background-color: #5a6268 !important;
        }
        /* Renderer area */
        .pvtRendererArea {
            margin-top: 20px !important;
            display: block !important;
            visibility: visible !important;
            min-height: 200px !important;
        }
        .pvtTable {
            font-size: 10px !important;
            width: 100% !important;
            border-collapse: collapse !important;
            color: #000 !important;
        }
        .pvtTable td,
        .pvtTable th {
            color: #000 !important;
        }
        /* Ensure all pivot table elements are visible */
        .pvtUi * {
            visibility: visible !important;
            color: #000 !important;
            font-size: 11px !important;
        }
        /* Pivot table text labels and headers */
        .pvtAxisContainer label,
        .pvtUi label,
        .pvtRendererArea label {
            color: #000 !important;
            font-size: 11px !important;
        }
        .pvtAxisContainer li {
            font-size: 10px !important;
        }
        /* Headings and text */
        h1 {
            font-size: 20px !important;
        }
        h2 {
            font-size: 18px !important;
        }
        h3 {
            font-size: 16px !important;
        }
        h4, h5, h6 {
            font-size: 14px !important;
        }
        p, span, div,
        .breadcrumb,
        .breadcrumb a,
        .container,
        .container * {
            color: #000 !important;
            font-size: 12px !important;
        }
        label {
            font-size: 12px !important;
        }
        input, select, button {
            font-size: 12px !important;
        }
        /* Keep links functional but ensure they're visible */
        a:not(.btn):not(.cd-footer-social__link):not(.cd-ocha-dropdown__link a) {
            color: #000 !important;
        }
        a:not(.btn):not(.cd-footer-social__link):not(.cd-ocha-dropdown__link a):hover {
            color: #333 !important;
        }
        /* Override any Bootstrap hiding */
        #pivot-table-container .pvtUi,
        #pivot-table-container .pvtAxisContainer,
        #pivot-table-container .pvtRendererArea {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* Force visibility of all pivot table components */
        #pivot-table-container .pvtUi,
        #pivot-table-container .pvtAxisContainer,
        #pivot-table-container .pvtUnused,
        #pivot-table-container .pvtRendererArea,
        #pivot-table-container .pvtTable,
        #pivot-table-container table,
        #pivot-table-container ul,
        #pivot-table-container li {
            display: block !important;
            visibility: visible !important;
        }
        #pivot-table-container .pvtAxisContainer li {
            display: inline-block !important;
        }
        /* Ensure the container itself is visible */
        #pivot-table-container {
            position: relative !important;
            z-index: 1 !important;
        }
        /* Logo without text - ensure it's visible */
        .navbar-brand.logo {
            display: inline-block !important;
            width: 200px !important;
            height: 50px !important;
            text-indent: -9999px !important;
            overflow: hidden !important;
        }
    </style>
</head>
<body>
    <header class="cd-header">
	<div class="cd-global-header">
		<div class="container">
			<div class="cd-ocha">
				<button type="button" class="cd-ocha-btn cd-global-header__dropdown-btn" data-toggle="dropdown" id="cd-ocha-dropdown-toggle" aria-expanded="false" aria-label="OCHA Services">
					<span class="cd-ocha-btn__logo" aria-hidden="true"></span>
					<span class="cd-ocha-btn__label">OCHA Services</span>
					<svg class="icon icon--arrow-down" style="background-color: transparent">
      					<use xlink:href="#arrow-down"></use>
    				</svg>
			  	</button>
				<div class="cd-global-header__dropdown cd-ocha-dropdown cd-dropdown" role="menu" id="cd-ocha-dropdown" aria-labelledby="cd-ocha-dropdown-toggle">
					<div class="cd-ocha-dropdown__inner">
					  <div class="cd-ocha-dropdown__section">
						<p class="cd-ocha-dropdown__heading">Related Platforms</p>
						<ul class="cd-ocha-dropdown__list">
						  <li class="cd-ocha-dropdown__link"><a href="https://gms.unocha.org/">CBPF GMS Portal</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://gms-blog.unocha.org">CBPF GMS Blog</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://gms.unocha.org/support">GMS Help Portal</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://www.unocha.org/our-work/humanitarian-financing/country-based-pooled-funds-cbpf">About CBPF</a></li>
						</ul>
					  </div>
					  <div class="cd-ocha-dropdown__section">
						<p class="cd-ocha-dropdown__heading">Other OCHA Services</p>
						<ul class="cd-ocha-dropdown__list">
						  <li class="cd-ocha-dropdown__link"><a href="https://fts.unocha.org/">Financial Tracking Service</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://data.humdata.org/">Humanitarian Data Exchange</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://humanitarian.id/">Humanitarian ID</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://humanitarianresponse.info/">Humanitarian Response</a></li>
						</ul>
					  </div>
					  <div class="cd-ocha-dropdown__section">
						<p class="cd-ocha-dropdown__heading" aria-hidden="true">&nbsp;</p>
						<ul class="cd-ocha-dropdown__list">
						  <li class="cd-ocha-dropdown__link"><a href="https://interagencystandingcommittee.org/">Inter-Agency Standing Committee</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://unocha.org/">OCHA website</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://reliefweb.int/">ReliefWeb</a></li>
						  <li class="cd-ocha-dropdown__link"><a href="https://vosocc.unocha.org/">Virtual OSOCC</a></li>
						</ul>
					  </div>
					  <div class="cd-ocha-dropdown__section">
						<a class="cd-ocha-dropdown__see-all" href="https://www.unocha.org/ocha-digital-services" target="_blank" rel="noopener">See all</a>
					  </div>
					</div>
  				</div>
			</div>
			<div class="cd-global-header__user-menu">
                <div id="block-hr-layout-hr-layout-login" class="block block-hr-layout">
                    <ul class="menu">
                        <li><a href="https://pfdata.unocha.org/">Pooled Funds Data Hub</a></li>
                        <li><a href="https://cerf.data.unocha.org">CERF Data Hub</a></li>
                    </ul>
                </div>						
            </div>
		</div>
	</div>
	</header>    
	<nav class="navbar navbar-light navbar-expand-lg bg-white clean-navbar" style="background-color:#fff;color:rgb(254,254,254); box-shadow: 0 2px 3px 0 #eee; -webkit-box-shadow: 0 2px 3px 0 #eee; -moz-box-shadow: 0 2px 3px 0 #eee;">
        <div class="container"><a class="navbar-brand logo" href="../index.html" style="background-repeat: no-repeat;background-size: contain;color: rgba(255,255,255,0);background-position: center;background-image: url(&quot;../assets/img/bi-logo.svg&quot;);"></a>
            <button class="navbar-toggler" data-toggle="collapse" data-target="#navcol-1"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navcol-1" style="font-family:Montserrat, sans-serif;">
                    <ul class="nav navbar-nav ml-auto">
						<li class="nav-item" role="presentation"><a class="nav-link" href="../index.html" style="color:#146eb4;">HOME</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" href="../dataexplorer.html" style="color:#146eb4;">DATA EXPLORER</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link active" href="../resources.html" style="color:#146eb4;">RESOURCES</a></li>
                    </ul>
                </div>
        </div>
    </nav>
    <div>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html" title="Home">Home</a></li>
                        <li class="breadcrumb-item">Pivot Table</li>
                    </ol>
                    <h1 class="text-center"><strong>CBPF Data Pivot Table</strong></h1>
                    <p class="text-center" style="max-width: 100%;"><br>Explore and analyze CBPF data using an interactive pivot table. Load CSV data from predefined endpoints or use your custom endpoint.<br><br></p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <main class="page">
                        <section class="clean-block features">
                            <div class="container">
                                <div class="pivot-controls">
                                    <div class="form-group">
                                        <label>
                                            <input type="radio" name="source" value="predefined" checked>
                                            Predefined CSV Endpoint
            </label>
                                        <label>
                                            <input type="radio" name="source" value="custom">
                                            Custom CSV Endpoint
            </label>
        </div>
                                    <div class="form-group">
                                        <select id="csv-endpoint" class="form-control" style="display: inline-block; width: auto; margin-right: 10px;">
                <option value="">Select a predefined CSV</option>
                <option value="https://cbpfapi.unocha.org/vo1/odata/ProjectSummary?poolfundAbbrv=&$format=csv">Project Summary</option>
                <option value="https://cbpfapi.unocha.org/vo1/odata/Contribution?poolfundAbbrv=&$format=csv">Contributions</option>
                <option value="https://cbpfapi.unocha.org/vo1/odata/Cluster?poolfundAbbrv=&$format=csv">Project by Cluster</option>
            </select>
                                        <input type="text" id="custom-csv-url" placeholder="Enter custom CSV URL" class="form-control hidden" style="display: inline-block; width: auto; margin-right: 10px;">
                                        <input type="text" id="username" placeholder="Username" value="EFA37075-41E3-47D4-B766-8DE718A9425F" class="form-control" style="display: inline-block; width: auto; margin-right: 10px;">
                                        <input type="password" id="password" placeholder="Password" class="form-control" style="display: inline-block; width: auto; margin-right: 10px;">
                                        <button id="load-csv" class="btn btn-primary">Load CSV</button>
                                        <button id="download-csv" class="btn btn-secondary ml-2">Download CSV</button>
        </div>
                                    <div id="loading" class="hidden text-center" style="display: none;">
            <div class="spinner"></div>
            <p>Loading CSV data...</p>
                                        <div class="progress mt-2" style="height: 20px;">
                                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
                                        </div>
            </div>
        </div>
        <div id="pivot-table-container" class="mt-4"></div>
        
        <!-- Export Button -->
                                <div class="text-center mt-4">
                                    <button id="export-button" class="btn btn-success hidden">Export Pivot Table as CSV</button>
                                </div>
                            </div>
                        </section>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <footer class="cd-footer" role="contentinfo">
  		<div class="container cd-footer__inner">    
			<div class="cd-footer__section cd-footer__section--menu">
  				<ul class="cd-footer-menu"><li class="menu-326 first"><a href="https://www.unocha.org/our-work/humanitarian-financing/country-based-pooled-funds-cbpf" title="">About</a></li>
					<li class="menu-355"><a href="../privacy-policy.html" title="">Privacy</a></li>
					<li class="menu-327 last"><a href="../privacy-policy.html" title="">Terms of use</a></li>
				</ul>
			</div>
    		<div class="cd-footer__section cd-footer__section--social">
			  <a href="https://twitter.com/cbpfs?lang=en" class="cd-footer-social__link">
				<span class="element-invisible">Twitter</span>
				<svg class="icon icon--twitter">
				  <use xlink:href="#sm-tt-def"></use>
				</svg>

				<svg class="icon icon--twitter hover-style">
				  <use xlink:href="#sm-tt-full"></use>
				</svg>
			  </a>

			  <a href="https://www.youtube.com/user/ochafilms" class="cd-footer-social__link">
				<span class="element-invisible">YouTube</span>

				<svg class="icon icon--youtube">
				  <use xlink:href="#sm-yt-def"></use>
				</svg>

				<svg class="icon icon--youtube hover-style">
				  <use xlink:href="#sm-yt-full"></use>
				</svg>
			  </a>
			</div>
    		<div class="cd-footer__section cd-footer__section--mandate">
			  <div class="cd-mandate">
				<span class="cd-mandate__heading">Service provided by</span>
				<span class="cd-mandate__logo">
				  <span class="element-invisible">UN-OCHA</span>
				</span>
				<span class="cd-mandate__text">
				  <p>OCHA coordinates the global emergency response to save lives and protect people in humanitarian crises. We advocate for effective and principled humanitarian action by all, for all.</p>
				</span>
			  </div>
			</div>
			<div class="cd-footer__section cd-footer__section--copyright">
		  		<div class="cd-footer-copyright">
					<span class="cd-footer-copyright__text">Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0</a> International license.</span>
					<a class="cd-footer-copyright__link" href="https://creativecommons.org/licenses/by/4.0/">
			  		<span class="element-invisible">Creative Commons BY 4.0</span>
				  	<svg class="icon icon--cc">
						<use xlink:href="#creative-commons"></use>
				  	</svg>
					</a>
		  		</div>
			</div>
  		</div>
	</footer>
	<div style="display:none;">
		<svg class="icons-sprite" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 48 48" id="arrow-down" xmlns="http://www.w3.org/2000/svg"><path d="M48 14a4 4 0 0 1-1.17 2.83l-20 20a4 4 0 0 1-5.66 0l-20-20a4 4 0 0 1 5.66-5.66L24 28.34l17.17-17.17A4 4 0 0 1 48 14z"></path></symbol><symbol viewBox="0 0 32 32" id="creative-commons" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M15.886 28.968c-7.159.009-12.857-5.804-12.884-12.802C2.975 9.069 8.849 3.104 15.904 3.285c6.356-.152 12.793 4.975 12.829 12.839.035 7.721-6.201 12.836-12.847 12.844zM15.907.254C6.554.198.034 8.091 0 16.082-.036 24.585 6.961 32.009 15.827 32c8.53-.009 15.954-6.753 15.885-15.803.111-8.79-6.935-15.89-15.805-15.943z"></path><path fill="#fff" d="M25.263 18.406c-.958 1.921-3.394 2.767-5.132 2.632-4.489-.347-5.501-3.918-4.747-6.567.701-2.462 3.115-3.831 6.002-3.466 1.667.21 2.961.886 3.863 2.334l-2.382 1.157c-.165-.166-.288-.268-.381-.388-.535-.7-1.25-.982-2.19-.822-.93.158-1.479.714-1.589 1.482a8.264 8.264 0 0 0 .039 2.482c.126.777.707 1.336 1.62 1.462.99.137 1.856-.059 2.38-.931.065-.108.161-.201.309-.382l2.208 1.007z"></path><path fill="#fff" d="M16.842 13.347l-2.391 1.138c-.156-.15-.304-.262-.412-.4-.545-.698-1.269-.964-2.203-.797-.888.159-1.44.687-1.541 1.432a8.907 8.907 0 0 0 .03 2.557c.122.784.725 1.323 1.637 1.444.956.126 1.8-.056 2.326-.887.081-.128.193-.241.346-.43l2.206 1.014c-.357.81-.978 1.311-1.659 1.759-2.518 1.661-6.749.909-7.962-1.851-1.013-2.305-.422-5.145 1.656-6.505 2.136-1.398 5.664-1.088 7.33.691.212.226.376.49.636.834z"></path></symbol><symbol viewBox="0 0 48 48" id="sm-tt-def" xmlns="http://www.w3.org/2000/svg"><path d="M24 5A19 19 0 1 1 5 24 19 19 0 0 1 24 5m0-3a22 22 0 1 0 22 22A22 22 0 0 0 24 2z"></path><path d="M36 16.56a9.83 9.83 0 0 1-2.83.78 4.94 4.94 0 0 0 2.16-2.72 9.84 9.84 0 0 1-3.13 1.19 4.93 4.93 0 0 0-8.52 3.37 5 5 0 0 0 .13 1.12 14 14 0 0 1-10.15-5.14 4.93 4.93 0 0 0 1.52 6.57 4.9 4.9 0 0 1-2.18-.62v.06A4.93 4.93 0 0 0 16.91 26a4.9 4.9 0 0 1-1.3.17 5 5 0 0 1-.93-.09 4.93 4.93 0 0 0 4.6 3.42 9.91 9.91 0 0 1-7.29 2 14 14 0 0 0 21.57-11.76v-.64A10 10 0 0 0 36 16.56z"></path></symbol><symbol viewBox="0 0 48 48" id="sm-tt-full" xmlns="http://www.w3.org/2000/svg"><path d="M24 2a22 22 0 1 0 22 22A22 22 0 0 0 24 2zm9.54 17.11v.64A14 14 0 0 1 12 31.54a9.92 9.92 0 0 0 7.29-2 4.93 4.93 0 0 1-4.6-3.42 5 5 0 0 0 .93.09 4.9 4.9 0 0 0 1.3-.17A4.93 4.93 0 0 1 13 21.17v-.06a4.9 4.9 0 0 0 2.23.62 4.93 4.93 0 0 1-1.52-6.57 14 14 0 0 0 10.15 5.14 5 5 0 0 1-.13-1.12 4.93 4.93 0 0 1 8.52-3.37 9.83 9.83 0 0 0 3.13-1.19 4.94 4.94 0 0 1-2.16 2.72 9.83 9.83 0 0 0 2.78-.78 10 10 0 0 1-2.46 2.55z"></path></symbol><symbol viewBox="0 0 48 48" id="sm-yt-def" xmlns="http://www.w3.org/2000/svg"><path d="M32.58 16.83c-1.72-.45-8.59-.45-8.59-.45s-6.75 0-8.46.42a3 3 0 0 0-2.11 2A26.77 26.77 0 0 0 13 24a26.77 26.77 0 0 0 .42 5.24 3 3 0 0 0 2.11 2c1.72.46 8.46.42 8.46.42s6.75 0 8.46-.42a3 3 0 0 0 2.08-2A27.91 27.91 0 0 0 35 24a28.42 28.42 0 0 0-.47-5.24 2.74 2.74 0 0 0-1.95-1.93zM21.26 27.38v-6.76L26.74 24z"></path><path d="M24 2a22 22 0 1 0 22 22A22 22 0 0 0 24 2zm0 41a19 19 0 1 1 19-19 19 19 0 0 1-19 19z"></path></symbol><symbol viewBox="0 0 48 48" id="sm-yt-full" xmlns="http://www.w3.org/2000/svg"><path d="M24 2a22 22 0 1 0 22 22A22 22 0 0 0 24 2zm10.54 27.24a3 3 0 0 1-2.08 2c-1.72.45-8.46.42-8.46.42s-6.75 0-8.46-.42a3 3 0 0 1-2.11-2A26.77 26.77 0 0 1 13 24a26.77 26.77 0 0 1 .42-5.24 3 3 0 0 1 2.11-2c1.72-.45 8.46-.42 8.46-.42s6.87 0 8.59.45a2.74 2.74 0 0 1 1.94 1.93A28.42 28.42 0 0 1 35 24a27.91 27.91 0 0 1-.46 5.24z"></path><path d="M21.25 27.38l5.5-3.38-5.5-3.38v6.76z"></path></symbol></svg>
	</div>
    <script src="../assets/js/jquery.min.js"></script>
	<script src="../assets/js/bootstrap-dropdown.js"></script>
	<script src="../assets/js/custom-menu.js"></script>
    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/d3_renderers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/c3_renderers.min.js"></script>
    <script>
	$(document).ready(function(){
	  $(".cd-ocha-btn").click(function(){
		$(".cd-dropdown").toggle();
	  });
		$(window).on('click', function () {
     		$( '#cd-ocha-dropdown' ).css( 'display','none' ); //$( '#layers' ).hide();
   		});
	});
	</script>
    <script>
        $(document).ready(function() {
            let pivotData; // Variable to hold pivot table data
            let lastLoadedUrl; // Variable to store the last loaded URL for downloading

            // Handle radio button toggle
            $('input[name="source"]').on('change', function() {
                if ($(this).val() === 'predefined') {
                    $('#csv-endpoint').show();
                    $('#custom-csv-url').addClass('hidden').hide();
                } else {
                    $('#csv-endpoint').hide();
                    $('#custom-csv-url').removeClass('hidden').show();
                }
            });
            
            // Set initial state
            if ($('input[name="source"]:checked').val() === 'predefined') {
                $('#csv-endpoint').show();
                $('#custom-csv-url').addClass('hidden').hide();
            } else {
                $('#csv-endpoint').hide();
                $('#custom-csv-url').removeClass('hidden').show();
            }

            $('#load-csv').on('click', function() {
                const selectedUrl = $('#csv-endpoint').val() || $('#custom-csv-url').val();
                if (selectedUrl) {
                    lastLoadedUrl = selectedUrl; // Store the last loaded URL
                    $('#loading').removeClass('hidden').show();
                    $('#progress-bar').css('width', '10%'); // Show initial progress
                    
                    // Use fetch to download with progress tracking
                    const username = $('#username').val();
                    const password = $('#password').val();
                    const headers = {};
                    
                    if (username && password) {
                        headers['Authorization'] = 'Basic ' + btoa(username + ':' + password);
                    }
                    
                    fetch(selectedUrl, {
                        method: 'GET',
                        headers: headers
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.text();
                    })
                    .then(csvText => {
                        $('#progress-bar').css('width', '50%'); // Show parsing progress
                        
                        // Parse the CSV text
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                        complete: function(results) {
                                $('#progress-bar').css('width', '100%'); // Show complete

                            // Store the data for exporting later
                            pivotData = results.data;
                            console.log("Pivot Data:", pivotData);
                                
                                // Check if pivotData is not empty and has valid data
                                if (pivotData && pivotData.length > 0 && Object.keys(pivotData[0]).length > 0) {
                                    // Filter out empty rows and ensure data is in correct format
                                    pivotData = pivotData.filter(row => {
                                        // Check if row has at least one non-empty value
                                        const hasData = Object.values(row).some(val => val && val.toString().trim() !== '');
                                        // Also ensure it's a proper object, not null/undefined
                                        return hasData && row && typeof row === 'object';
                                    });
                                    
                                    if (pivotData.length === 0) {
                                        alert("No valid data found in CSV. All rows appear to be empty.");
                                        $('#loading').addClass('hidden').hide();
                                        return;
                                    }
                                    
                                    // Ensure all rows have the same structure
                                    const firstRowKeys = Object.keys(pivotData[0]);
                                    pivotData = pivotData.filter(row => {
                                        const rowKeys = Object.keys(row);
                                        return rowKeys.length === firstRowKeys.length && 
                                               firstRowKeys.every(key => rowKeys.includes(key));
                                    });
                                    
                                    console.log("Filtered data:", pivotData.length, "rows");
                                    console.log("First row keys:", Object.keys(pivotData[0]));
                                    
                                    // Clear previous pivot table
                                    $("#pivot-table-container").empty().show();
                                    
                                    // Get all available field names
                                    const fieldNames = Object.keys(pivotData[0]);
                                    console.log("Available fields:", fieldNames);
                                    console.log("Data sample:", pivotData.slice(0, 3));
                                    
                                    // Ensure container is visible and has proper dimensions
                                    $("#pivot-table-container").css({
                                        'display': 'block',
                                        'visibility': 'visible',
                                        'min-height': '500px',
                                        'width': '100%',
                                        'overflow': 'visible'
                                    });
                                    
                                    // Small delay to ensure DOM is ready
                                    setTimeout(function() {
                                        // Initialize the pivot table UI - let users drag fields
                                        try {
                                            console.log("Initializing pivotUI with data:", pivotData.length, "rows");
                                            console.log("Container element:", $("#pivot-table-container").length);
                                            
                                            // Check if pivotUI function exists
                                            if (typeof $.fn.pivotUI === 'undefined') {
                                                throw new Error("pivotUI function not found. Make sure pivot.min.js is loaded.");
                                            }
                                            
                                            // Initialize pivot table with minimal config
                                            $("#pivot-table-container").pivotUI(
                                                pivotData,
                                                {
                                                    rows: [],
                                                    cols: [],
                                                    vals: fieldNames.length > 1 ? [fieldNames[1]] : [],
                                                    aggregatorName: "Sum",
                                                    rendererName: "Table"
                                                },
                                                true,
                                                "en"
                                            );
                                            
                                            console.log("Pivot table UI initialized successfully");
                                            console.log("Container HTML length:", $("#pivot-table-container").html().length);
                                            
                                            // Verify elements were created
                                            setTimeout(function() {
                                                const hasPvtUi = $("#pivot-table-container .pvtUi").length > 0;
                                                const hasAxisContainers = $("#pivot-table-container .pvtAxisContainer").length > 0;
                                                console.log("Has .pvtUi:", hasPvtUi);
                                                console.log("Has .pvtAxisContainer:", hasAxisContainers);
                                                
                                                if (!hasPvtUi) {
                                                    console.error("Pivot UI not found in container!");
                                                    alert("Pivot table UI did not render. Check console for errors.");
                                                }
                                            }, 500);
                                            
                                        } catch (error) {
                                            console.error("Error initializing pivot table:", error);
                                            console.error("Error stack:", error.stack);
                                            alert("Error creating pivot table: " + error.message + "\n\nCheck browser console for details.");
                                        }
                                    }, 100);

                                // Show the export button
                                    $('#export-button').removeClass('hidden').show();
                                    console.log("Pivot table UI initialization started. You should see drag-and-drop areas for fields.");
                            } else {
                                console.error("No data available for pivot table.");
                                    alert("No data available for pivot table. The CSV may be empty or invalid.");
                            }
                                
                                // Hide loading after a short delay
                                setTimeout(function() {
                                    $('#loading').addClass('hidden').hide();
                                }, 500);
                        },
                        error: function(error) {
                                console.error("Error parsing CSV:", error);
                                $('#loading').addClass('hidden').hide();
                                alert("Error parsing CSV: " + error);
                            }
                        });
                    })
                    .catch(error => {
                        console.error("Error loading CSV:", error);
                        $('#loading').addClass('hidden').hide();
                        alert("Error loading CSV: " + error.message);
                    });
                } else {
                    alert("Please select a CSV endpoint.");
                }
            });

            // Download CSV functionality
            $('#download-csv').on('click', function() {
                const selectedUrl = $('#csv-endpoint').val() || $('#custom-csv-url').val();
                const username = $('#username').val();
                const password = $('#password').val();

                if (selectedUrl) {
                    if (username && password) {
                        // Use Fetch API for basic authentication
                        fetch(selectedUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': 'Basic ' + btoa(username + ':' + password)
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.blob(); // Get the response as a Blob
                        })
                        .then(blob => {
                            const link = document.createElement("a");
                            const url = URL.createObjectURL(blob);
                            link.href = url;
                            link.download = "data.csv"; // Default filename
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        })
                        .catch(error => {
                            console.error("Error downloading CSV:", error);
                            alert("Error downloading CSV: " + error);
                        });
                    } else {
                        // For predefined URLs, download directly
                        const link = document.createElement("a");
                        link.href = selectedUrl;
                        link.download = "data.csv"; // Default filename
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } else {
                    alert("Please select a CSV endpoint to download.");
                }
            });

            // Export to CSV functionality
            $('#export-button').on('click', function() {
                if (pivotData && pivotData.length > 0) {
                const csv = Papa.unparse(pivotData); // Convert pivot data to CSV
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "pivot_table_data.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                } else {
                    alert("No data to export. Please load CSV data first.");
                }
            });
        });
    </script>
</body>
</html>
